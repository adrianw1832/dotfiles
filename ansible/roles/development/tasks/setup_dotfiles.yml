- name: Check for existing dotfiles
  stat:
    path: '{{ item.dest }}'
  register: dotfile_exists
  with_items: '{{ dotfiles }}'

- name: Backup existing dotfiles
  copy:
    src: '{{ item.item.dest }}'
    dest: '{{ item.item.dest }}.backup'
  with_items: '{{ dotfile_exists.results }}'
  when: item.stat.exists

- name: Create symlinks for dotfiles
  file:
    src: "{{ lookup('env','PWD') }}/{{ item.src }}"
    dest: '{{ item.dest }}'
    state: link
    force: yes
    follow: false
  with_items: '{{ dotfiles }}'
